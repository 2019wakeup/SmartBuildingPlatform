# 智能云平台数据实体重构说明

## 重构概述

根据您提供的新表结构需求，我已经完成了数据实体的重构工作，主要包括以下几个方面：

## 1. 实体类重构

### 1.1 User 实体 (用户表)
- **保留字段**: userID, userName, account, password, email, phone
- **新增字段**: roleID (外键关联Role表), sampleID (外键关联BreathSample表)
- **移除字段**: status, delFlag, loginIp, loginDate 等冗余字段
- **关联对象**: Role, BreathSample, UserRoles列表

### 1.2 Role 实体 (角色表)
- **保留字段**: roleID, roleName
- **新增字段**: userID (外键关联User表), permissionID (外键关联Permission表)
- **移除字段**: roleKey, roleSort, dataScope, status, delFlag 等复杂字段
- **关联对象**: User, Permission, RolePermissions列表

### 1.3 Permission 实体 (权限表)
- **保留字段**: permissionID, code
- **移除字段**: permissionName, permissionType, parentId, orderNum, path, component 等菜单相关字段
- **简化为**: 仅包含权限ID和权限代码的基础权限表
- **关联对象**: RolePermissions列表

### 1.4 新增实体类

#### BreathSample 实体 (呼吸样本表)
- **字段**: sampleID (主键), dataTaken (采集时间), userID (外键)
- **用途**: 用于健康检测的呼吸样本数据存储
- **关联对象**: User

#### UserRoles 实体 (用户角色关系表)
- **字段**: userID (外键), roleID (外键)
- **用途**: 多对多关系，用户可以拥有多个角色
- **关联对象**: User, Role

#### RolePermissions 实体 (角色权限关系表)
- **字段**: roleID (外键), permissionID (外键)
- **用途**: 多对多关系，角色可以拥有多个权限
- **关联对象**: Role, Permission

## 2. 数据库表结构

### 2.1 表关系设计
```
User (1) ←→ (N) UserRoles (N) ←→ (1) Role
Role (1) ←→ (N) RolePermissions (N) ←→ (1) Permission
User (1) ←→ (N) BreathSample
User (N) ←→ (1) Role (直接关联)
User (N) ←→ (1) BreathSample (直接关联)
```

### 2.2 外键约束
- User.roleID → Role.roleID
- User.sampleID → BreathSample.sampleID
- Role.userID → User.userID
- Role.permissionID → Permission.permissionID
- BreathSample.userID → User.userID
- UserRoles.userID → User.userID
- UserRoles.roleID → Role.roleID
- RolePermissions.roleID → Role.roleID
- RolePermissions.permissionID → Permission.permissionID

## 3. 修复的问题

### 3.1 编译错误修复
- 修复了 `SysRoleController` 中使用已删除字段的编译错误
- 移除了对 `roleKey` 和 `status` 字段的引用
- 更新了控制器中的示例数据创建逻辑

### 3.2 依赖关系
- 创建了缺失的实体类 (`BreathSample`, `UserRoles`, `RolePermissions`)
- 添加了正确的导入语句和注解
- 保持了与MyBatis Plus和Swagger的兼容性

## 4. SQL建表脚本

已创建 `sql_new_structure.sql` 文件，包含：
- 完整的数据库表结构定义
- 所有外键约束
- 示例数据插入
- 适当的索引优化

## 5. 特性保持

### 5.1 保留的框架特性
- MyBatis Plus 注解支持
- Swagger API 文档注解
- 数据验证注解 (JSR-303)
- Lombok 自动生成getter/setter
- BaseEntity 继承 (审计字段)

### 5.2 数据库特性
- 自动时间戳更新
- 软删除支持 (通过BaseEntity)
- 字符集UTF8MB4支持
- 适当的索引优化

## 6. 使用建议

### 6.1 数据迁移
1. 备份现有数据
2. 执行 `sql_new_structure.sql` 创建新表结构
3. 编写数据迁移脚本将旧数据迁移到新结构

### 6.2 代码适配
1. 更新相关的Service和Mapper类
2. 修改业务逻辑以适应新的关系结构
3. 更新前端接口调用

### 6.3 测试建议
1. 单元测试所有实体类的CRUD操作
2. 集成测试外键约束
3. 性能测试多表关联查询

## 7. 项目状态

- ✅ 实体类重构完成
- ✅ 编译错误修复
- ✅ SQL建表脚本生成
- ✅ 基本功能验证通过
- ⏳ 需要后续的Service层和Mapper层适配

重构后的数据实体结构更加清晰，符合您提供的表结构要求，同时保持了良好的扩展性和维护性。 